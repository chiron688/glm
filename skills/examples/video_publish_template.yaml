schema_version: v1
id: "video_publish_template"
name: "Video Publish Template"
version: "1.3.3"
description: "Template skill for publishing a video with robust error handling."
app:
  name: "TikTok"
  packages:
    - "com.zhiliaoapp.musically"
platforms: ["adb"]
risk: high
level: 2
role: flow
owner: system2
vocab_path: "skills/common/vocab.yaml"
vars:
  default_caption: ""
inputs:
  video_path:
    type: file
    required: true
  caption:
    type: string
    default: "{{default_caption}}"
preconditions:
  mode: best_effort
  condition:
    app_is: "TikTok"
error_handlers:
  - name: "dismiss_update_prompt"
    trigger: before_step
    when:
      text_any_contains: "{{update_prompt_markers}}"
    actions:
      - action: Tap
        target:
          type: selector
          selector:
            text: "{{rx_later}}"
            match: regex
    resolution: continue
  - name: "permission_allow"
    trigger: before_step
    when:
      text_any_contains: "{{allow_markers}}"
    actions:
      - action: Tap
        target:
          type: selector
          selector:
            text: "{{rx_allow}}"
            match: regex
    resolution: continue
steps:
  - id: "open_create"
    action: Tap
    target:
      type: selector
      selector:
        text: "{{rx_create}}"
        match: regex
    retry:
      max_attempts: 2
      backoff_ms: 500
      on_codes: ["TARGET_NOT_FOUND", "ACTION_FAILED"]
    on_error:
      - name: "fallback_plus_button"
        trigger: on_error
        codes: ["TARGET_NOT_FOUND"]
        actions:
          - action: Tap
            target:
              type: selector
              selector:
                text: "+"
                match: exact
        resolution: retry
  - id: "select_video"
    action: Tap
    target:
      type: selector
      selector:
        text: "{{rx_upload}}"
        match: regex
    assert:
      condition:
        text_any_contains: "{{gallery_markers}}"
      timeout_ms: 5000
      poll_interval_ms: 500
  - id: "pick_first_asset"
    action: Tap
    target:
      type: coords
      coords: [500, 350]
      coords_type: relative
    wait:
      after_ms: 800
  - id: "confirm_asset"
    action: Tap
    target:
      type: selector
      selector:
        text: "{{rx_next}}"
        match: regex
    retry:
      max_attempts: 2
      backoff_ms: 800
      on_codes: ["ACTION_FAILED", "POSTCONDITION_FAILED"]
    assert:
      condition:
        text_any_contains: "{{caption_markers}}"
      timeout_ms: 6000
  - id: "enter_caption"
    action: Tap
    target:
      type: selector
      selector:
        text: "{{rx_caption}}"
        match: regex
  - id: "type_caption"
    action: Type
    text: "{{caption}}"
  - id: "publish"
    action: Tap
    confirm: "Publish content to external platform"
    target:
      type: selector
      selector:
        text: "{{rx_post}}"
        match: regex
    retry:
      max_attempts: 2
      backoff_ms: 1000
      on_codes: ["ACTION_FAILED", "POSTCONDITION_FAILED"]
    assert:
      condition:
        text_any_contains: "{{upload_success_markers}}"
      timeout_ms: 15000
postconditions:
  mode: best_effort
  condition:
    text_any_contains: "{{upload_success_markers}}"
